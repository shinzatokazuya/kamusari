{% extends "layout.html" %}

{% block body %}
<div class="controls-container">
    <h3>
        Campeonato Brasileiro
        {% if q %}Clube: {{ q }}{% endif %}
        {% if ano_selecionado %} de {{ ano_selecionado }} {% endif %}
    </h3>

    <div class="selects-container">
        <select id="select-ano-search">
            <option value="">Selecione outro Ano</option>
            {% for year in datas %}
                <option value="{{ year }}" {% if year == ano_selecionado %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown de rodada s√≥ aparece para pontos corridos (2003+) -->
        <select id="select-rodada-search" {% if not ano_selecionado or formato_campeonato != 'pontos_corridos' %}style="display: none;"{% endif %}>
            <option value="">Selecione a Rodada</option>
        </select>

        <!-- Bot√£o para mostrar chaveamento (apenas para mata-mata) -->
        <button id="btn-toggle-chaveamento" class="btn-toggle-chaveamento"
                {% if not ano_selecionado or formato_campeonato == 'pontos_corridos' %}style="display: none;"{% endif %}>
            <span class="chaveamento-icon">üèÜ</span>
            <span class="chaveamento-text">Ver Chaveamento</span>
        </button>
    </div>

    {% if formato_campeonato and formato_campeonato != 'pontos_corridos' %}
        <div class="aviso-formato alert alert-info">
            <p>
                ‚ÑπÔ∏è <strong>Formato Hist√≥rico:</strong>
                {% if formato_campeonato == 'grupos_fases' %}
                    Este campeonato foi disputado em grupos e fases eliminat√≥rias.
                {% elif formato_campeonato == 'mata_mata' %}
                    Este campeonato foi disputado em formato mata-mata e fases classificat√≥rias.
                {% endif %}
                A classifica√ß√£o mostrada √© a final do campeonato.
            </p>
        </div>
    {% endif %}
</div>

<!-- Container do Chaveamento (inicialmente oculto) -->
<div id="chaveamento-container" class="chaveamento-container" style="display: none;">
    <div class="chaveamento-header">
        <h2 class="chaveamento-title">Chaveamento do Mata-Mata</h2>
    </div>
    <div id="chaveamento-content" class="chaveamento-wrapper"></div>
    <div class="chaveamento-legenda">
        <div class="legenda-item">
            <div class="legenda-cor vencedor"></div>
            <span>Vencedor</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor perdedor"></div>
            <span>Eliminado</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor penaltis"></div>
            <span>Decidido nos P√™naltis</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor prorrogacao"></div>
            <span>Teve Prorroga√ß√£o</span>
        </div>
    </div>
</div>

<div class="container-tabelas-search">
    <div class="table-section">
        <h2 id="classificacao-titulo">Classifica√ß√£o
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} Final de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} de {{ ano_selecionado }} at√© a Rodada {{ rodada_selecionada }}
                    {% endif %}
                {% else %}
                    Final de {{ ano_selecionado }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-classificacao" id="tabela-classificacao-anual">
            <thead>
                <tr>
                    <th>Posi√ß√£o</th>
                    <th>Clube</th>
                    <th>Jogos</th>
                    <th>Pontos</th>
                    <th>Vit√≥rias</th>
                    <th>Empates</th>
                    <th>Derrotas</th>
                    <th>GM</th>
                    <th>GC</th>
                    <th>SG</th>
                </tr>
            </thead>
            <tbody id="tabela-classificacao-anual-tbody">
                {% if classificacoes %}
                    {% for ranking in classificacoes %}
                    <tr>
                        <td>{{ ranking["posicao"] }}</td>
                        <td><a href="{{ url_for('clube', nome=ranking['clube']) }}">{{ ranking["clube"] }}</a></td>
                        <td>{{ ranking["total_jogos"] }}</td>
                        <td><strong>{{ ranking["pontos"] }}</strong></td>
                        <td>{{ ranking["vitorias"] }}</td>
                        <td>{{ ranking["empates"] }}</td>
                        <td>{{ ranking["derrotas"] }}</td>
                        <td>{{ ranking["gm"] }}</td>
                        <td>{{ ranking["gs"] }}</td>
                        <td>{{ ranking["sg"] }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="10" style="text-align: center;">Selecione um ano acima para ver a classifica√ß√£o.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="table-section">
        <h2 id="jogos-titulo">Jogos
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} da Rodada {{ rodada_selecionada }} de {{ ano_selecionado }}
                    {% endif %}
                {% else %}
                    de {{ ano_selecionado }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-jogos" id="tabela-jogos-anual">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Rodada/Fase</th>
                    <th>Mandante</th>
                    <th>Placar</th>
                    <th>Visitante</th>
                </tr>
            </thead>
            <tbody id="tabela-jogos-anual-tbody">
                {% if jogos %}
                    {% for jogo in jogos %}
                    <tr>
                        <td>{{ jogo["data"] }}</td>
                        <td>{{ jogo["rodada"] }}</td>
                        <td><a href="{{ url_for('clube', nome=jogo['mandante']) }}">{{ jogo["mandante"] }}</a></td>
                        <td><a href="{{ url_for('jogo', jogo_id=jogo['ID']) }}">{{ jogo["mandante_placar"] }} x {{ jogo["visitante_placar"] }}</a></td>
                        <td><a href="{{ url_for('clube', nome=jogo['visitante']) }}">{{ jogo["visitante"] }}</a></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5" style="text-align: center;">Selecione um ano acima para ver os jogos.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.ALL_CLUBS = {{ clubes_json | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        const selectAnoSearch = document.querySelector('#select-ano-search');
        const selectRodadaSearch = document.querySelector('#select-rodada-search');
        const btnToggleChaveamento = document.querySelector('#btn-toggle-chaveamento');
        const chaveamentoContainer = document.querySelector('#chaveamento-container');
        const chaveamentoContent = document.querySelector('#chaveamento-content');
        const tabelaClassificacaoTbody = document.querySelector('#tabela-classificacao-anual-tbody');
        const tabelaJogosTbody = document.querySelector('#tabela-jogos-anual-tbody');
        const anoSelecionadoHeader = document.querySelector('#classificacao-titulo');
        const jogosAnoHeader = document.querySelector('#jogos-titulo');

        let currentYear = {{ ano_selecionado | tojson }};
        let currentRodada = {{ rodada_selecionada | tojson }};
        let currentFormato = {{ formato_campeonato | tojson }};
        let chaveamentoVisible = false;

        // Toggle do chaveamento
        if (btnToggleChaveamento) {
            btnToggleChaveamento.addEventListener('click', async () => {
                chaveamentoVisible = !chaveamentoVisible;

                if (chaveamentoVisible) {
                    chaveamentoContainer.style.display = 'block';
                    btnToggleChaveamento.classList.add('active');
                    btnToggleChaveamento.querySelector('.chaveamento-text').textContent = 'Ocultar Chaveamento';
                    await loadChaveamento(currentYear);
                } else {
                    chaveamentoContainer.style.display = 'none';
                    btnToggleChaveamento.classList.remove('active');
                    btnToggleChaveamento.querySelector('.chaveamento-text').textContent = 'Ver Chaveamento';
                }
            });
        }

        async function loadChaveamento(year) {
            try {
                chaveamentoContent.innerHTML = '<div class="loading" style="margin: 40px auto;"></div>';

                const response = await fetch(`/api/chaveamento/${year}`);
                if (!response.ok) throw new Error('Erro ao carregar chaveamento');

                const chaveamento = await response.json();
                renderChaveamento(chaveamento);

            } catch (error) {
                console.error('Erro ao carregar chaveamento:', error);
                chaveamentoContent.innerHTML = `
                    <div class="no-data">
                        <p>Erro ao carregar o chaveamento. Tente novamente.</p>
                    </div>
                `;
            }
        }

        function renderChaveamento(chaveamento) {
            if (Object.keys(chaveamento).length === 0) {
                chaveamentoContent.innerHTML = `
                    <div class="no-data">
                        <p>Nenhum chaveamento dispon√≠vel para este ano.</p>
                    </div>
                `;
                return;
            }

            // Ordem das fases (do mais avan√ßado para o in√≠cio)
            const ordemFases = ['Final', 'Semifinal', 'Semi', 'Quartas', 'Oitavas', 'D√©cimas Sextas'];
            const fasesOrdenadas = [];

            ordemFases.forEach(nomeF => {
                Object.keys(chaveamento).forEach(fase => {
                    if (fase.includes(nomeF) && !fasesOrdenadas.includes(fase)) {
                        fasesOrdenadas.push(fase);
                    }
                });
            });

            // Adicionar fases restantes
            Object.keys(chaveamento).forEach(fase => {
                if (!fasesOrdenadas.includes(fase)) {
                    fasesOrdenadas.push(fase);
                }
            });

            let html = '<div class="chaveamento-fases">';

            fasesOrdenadas.reverse().forEach(fase => {
                const jogos = chaveamento[fase];

                html += `
                    <div class="fase">
                        <div class="fase-header">
                            <h3 class="fase-title">${fase}</h3>
                        </div>
                        <div class="fase-confrontos">
                `;

                jogos.forEach(jogo => {
                    const mandanteVencedor = jogo.vencedor === jogo.mandante;
                    const visitanteVencedor = jogo.vencedor === jogo.visitante;
                    const temPenaltis = jogo.mandante_penalti !== null && jogo.visitante_penalti !== null;
                    const temProrrogacao = jogo.prorrogacao;

                    html += `
                        <div class="confronto ${jogo.vencedor ? 'finalizado' : 'aguardando'}">
                            <div class="confronto-time ${mandanteVencedor ? 'vencedor' : (visitanteVencedor ? 'perdedor' : '')}">
                                <div class="time-nome">
                                    <a href="/clube/${jogo.mandante}">${jogo.mandante}</a>
                                    ${mandanteVencedor ? '<span class="vencedor-icon">‚úì</span>' : ''}
                                </div>
                                <div class="time-placar">${jogo.mandante_placar !== null ? jogo.mandante_placar : '-'}</div>
                            </div>
                            <div class="confronto-time ${visitanteVencedor ? 'vencedor' : (mandanteVencedor ? 'perdedor' : '')}">
                                <div class="time-nome">
                                    <a href="/clube/${jogo.visitante}">${jogo.visitante}</a>
                                    ${visitanteVencedor ? '<span class="vencedor-icon">‚úì</span>' : ''}
                                </div>
                                <div class="time-placar">${jogo.visitante_placar !== null ? jogo.visitante_placar : '-'}</div>
                            </div>
                            <div class="confronto-info">
                                <div class="confronto-data">
                                    <a href="${makeUrlJogo(jogo.ID, jogo.mandante, jogo.visitante)}">${jogo.data || 'Data n√£o definida'}</a>
                                </div>
                                <div>
                                    ${temProrrogacao ? '<span class="confronto-prorrogacao">PRORR.</span>' : ''}
                                    ${temPenaltis ? `<span class="confronto-penaltis">P√™naltis: ${jogo.mandante_penalti} - ${jogo.visitante_penalti}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            chaveamentoContent.innerHTML = html;
        }

        function makeUrlJogo(id, mandante, visitante) {
            const slug = `${slugify(mandante)}-vs-${slugify(visitante)}`;
            return `/jogo/${id}/${slug}`;
        }

        function slugify(text) {
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s-]/g, '')
                .replace(/[-\s]+/g, '-')
                .trim();
        }

        async function checkFormatoAndPopulateRodada(year) {
            try {
                const formatoResp = await fetch(`/api/formato_campeonato/${year}`);
                const formatoData = await formatoResp.json();
                currentFormato = formatoData.formato;

                if (currentFormato === 'pontos_corridos') {
                    await populateRodadaDropdown(year);
                    selectRodadaSearch.style.display = 'inline-block';
                } else {
                    selectRodadaSearch.style.display = 'none';
                }

                return currentFormato;
            } catch (error) {
                console.error('Erro ao verificar formato:', error);
                return 'pontos_corridos';
            }
        }

        async function populateRodadaDropdown(year, selectedRodada = null) {
            selectRodadaSearch.innerHTML = '<option value="">Selecione a Rodada</option>';
            selectRodadaSearch.innerHTML += '<option value="0">Classifica√ß√£o Final / Todos os Jogos</option>';

            if (!year) {
                selectRodadaSearch.style.display = 'none';
                return 0;
            }

            let maxRodadaFromAPI = 0;

            try {
                const response = await fetch(`/api/max_rodada/${year}`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar rodadas.');
                }
                maxRodadaFromAPI = await response.json();

                if (typeof maxRodadaFromAPI === 'number' && maxRodadaFromAPI > 0) {
                    for (let i = 1; i <= maxRodadaFromAPI; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Rodada ${i}`;
                        selectRodadaSearch.appendChild(option);
                    }
                    selectRodadaSearch.style.display = 'inline-block';
                }

                let defaultSelection = null;
                if (selectedRodada !== null && (selectedRodada === 0 || (maxRodadaFromAPI > 0 && selectedRodada <= maxRodadaFromAPI))) {
                    defaultSelection = selectedRodada;
                } else if (maxRodadaFromAPI > 0) {
                    defaultSelection = maxRodadaFromAPI;
                } else {
                    defaultSelection = "0";
                }

                if (defaultSelection !== null && selectRodadaSearch.querySelector(`option[value="${defaultSelection}"]`)) {
                    selectRodadaSearch.value = defaultSelection;
                }

            } catch (error) {
                console.error('Erro:', error);
                selectRodadaSearch.innerHTML = '<option value="">Erro ao carregar rodadas</option>';
                selectRodadaSearch.style.display = 'inline-block';
            }
            return maxRodadaFromAPI;
        }

        async function updateTables(year, rodada) {
            tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Carregando...</td></tr>`;
            tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>`;

            if (anoSelecionadoHeader) {
                if (currentFormato === 'pontos_corridos') {
                    if (rodada === 0) {
                        anoSelecionadoHeader.textContent = `Classifica√ß√£o Final de ${year}`;
                    } else {
                        anoSelecionadoHeader.textContent = `Classifica√ß√£o de ${year} at√© a Rodada ${rodada}`;
                    }
                } else {
                    anoSelecionadoHeader.textContent = `Classifica√ß√£o Final de ${year}`;
                }
            }

            if (jogosAnoHeader) {
                if (currentFormato === 'pontos_corridos') {
                    if (rodada === 0) {
                        jogosAnoHeader.textContent = `Todos os Jogos de ${year}`;
                    } else {
                        jogosAnoHeader.textContent = `Jogos da Rodada ${rodada} de ${year}`;
                    }
                } else {
                    jogosAnoHeader.textContent = `Jogos de ${year}`;
                }
            }

            try {
                const classificacaoResponse = await fetch(`/api/classificacao/${year}/${rodada}`);
                if (!classificacaoResponse.ok) throw new Error('Erro ao carregar classifica√ß√£o.');
                const classificacoes = await classificacaoResponse.json();

                tabelaClassificacaoTbody.innerHTML = '';
                if (classificacoes.length > 0) {
                    classificacoes.forEach(ranking => {
                        const row = `
                            <tr>
                                <td>${ranking.posicao}</td>
                                <td><a href="/clube/${ranking.clube}">${ranking.clube}</a></td>
                                <td>${ranking.total_jogos}</td>
                                <td><strong>${ranking.pontos}</strong></td>
                                <td>${ranking.vitorias}</td>
                                <td>${ranking.empates}</td>
                                <td>${ranking.derrotas}</td>
                                <td>${ranking.gm}</td>
                                <td>${ranking.gs}</td>
                                <td>${ranking.sg}</td>
                            </tr>
                        `;
                        tabelaClassificacaoTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Nenhuma classifica√ß√£o encontrada.</td></tr>`;
                }

                const jogosResponse = await fetch(`/api/jogos/${year}/${rodada}`);
                if (!jogosResponse.ok) throw new Error('Erro ao carregar jogos.');
                const jogos = await jogosResponse.json();

                tabelaJogosTbody.innerHTML = '';
                if (jogos.length > 0) {
                    jogos.forEach(jogo => {
                        const row = `
                            <tr>
                                <td>${jogo.data}</td>
                                <td>${jogo.rodada}</td>
                                <td><a href="/clube/${jogo.mandante}">${jogo.mandante}</a></td>
                                <td><a href="/jogo/${jogo.ID}">${jogo.mandante_placar} x ${jogo.visitante_placar}</a></td>
                                <td><a href="/clube/${jogo.visitante}">${jogo.visitante}</a></td>
                            </tr>
                        `;
                        tabelaJogosTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum jogo encontrado.</td></tr>`;
                }

            } catch (error) {
                console.error('Erro:', error);
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Erro ao carregar dados.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados.</td></tr>`;
            }
        }

        selectAnoSearch.addEventListener('change', async () => {
            currentYear = selectAnoSearch.value;
            currentRodada = null;
            chaveamentoVisible = false;
            chaveamentoContainer.style.display = 'none';
            if (btnToggleChaveamento) {
                btnToggleChaveamento.classList.remove('active');
                btnToggleChaveamento.querySelector('.chaveamento-text').textContent = 'Ver Chaveamento';
            }

            if (currentYear) {
                const formato = await checkFormatoAndPopulateRodada(currentYear);

                // Mostrar/ocultar bot√£o de chaveamento baseado no formato
                if (btnToggleChaveamento) {
                    if (formato === 'pontos_corridos') {
                        btnToggleChaveamento.style.display = 'none';
                    } else {
                        btnToggleChaveamento.style.display = 'flex';
                    }
                }

                if (formato === 'pontos_corridos') {
                    const maxRodadaDoAno = await populateRodadaDropdown(currentYear, currentRodada);
                    const rodadaParaUsar = maxRodadaDoAno > 0 ? maxRodadaDoAno : 0;
                    history.pushState(null, '', `/search?data=${currentYear}&rodada=${rodadaParaUsar}`);
                    await updateTables(currentYear, rodadaParaUsar);
                } else {
                    history.pushState(null, '', `/search?data=${currentYear}`);
                    await updateTables(currentYear, 0);
                }
            } else {
                selectRodadaSearch.style.display = 'none';
                if (btnToggleChaveamento) btnToggleChaveamento.style.display = 'none';
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Selecione um ano.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Selecione um ano.</td></tr>`;
                history.pushState(null, '', `/search`);
            }
        });

        selectRodadaSearch.addEventListener('change', async () => {
            currentRodada = selectRodadaSearch.value ? parseInt(selectRodadaSearch.value) : null;
            if (currentYear && currentRodada !== null) {
                await updateTables(currentYear, currentRodada);
                history.pushState(null, '', `/search?data=${currentYear}&rodada=${currentRodada}`);
            }
        });

        // Inicializa√ß√£o
        if (currentYear) {
            checkFormatoAndPopulateRodada(currentYear).then(() => {
                if (currentFormato === 'pontos_corridos') {
                    populateRodadaDropdown(currentYear, currentRodada);
                }
            });
        }
    });
</script>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="../static/css/chaveamento.css">
<style>
    .controls-container {
        background: var(--bg-primary);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-3xl);
    }

    .controls-container h3 {
        margin: 0 0 var(--spacing-xl) 0;
        color: var(--text-primary);
        font-size: var(--font-size-2xl);
    }

    .selects-container {
        display: flex;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
        align-items: center;
    }

    .selects-container select {
        flex: 1;
        min-width: 200px;
    }

    .container-tabelas-search {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-3xl);
    }

    .table-section {
        background: var(--bg-primary);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .table-section h2 {
        margin: 0 0 var(--spacing-xl) 0;
        color: var(--text-primary);
        padding-bottom: var(--spacing-md);
        border-bottom: 3px solid var(--primary-color);
        font-size: var(--font-size-xl);
    }

    @media (max-width: 992px) {
        .container-tabelas-search {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}
