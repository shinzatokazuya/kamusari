{% extends "base.html" %}

{% block body %}
<div class="controls-container">
    <h3>
        Campeonato Brasileiro
        {% if q %}Clube: {{ q }}{% endif %}
        {% if ano_selecionado %} de {{ ano_selecionado }} {% endif %}
        {% if fase_selecionada %} - {{ fase_selecionada }} {% endif %}
    </h3>

    <div class="selects-container">
        <select id="select-ano-search">
            <option value="">Selecione um Ano</option>
            {% for year in datas %}
                <option value="{{ year }}" {% if year == ano_selecionado %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown de fase (para campeonatos com grupos/fases) -->
        <select id="select-fase-search" {% if not fases_disponiveis %}style="display: none;"{% endif %}>
            <option value="">Selecione a Fase</option>
            {% for fase in fases_disponiveis %}
                <option value="{{ fase }}" {% if fase == fase_selecionada %}selected{% endif %}>{{ fase }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown de rodada  -->
        <select id="select-rodada-search">
            <option value="">Selecione a Rodada</option>
        </select>

        <!-- Bot√£o para chaveamento (apenas para mata-mata) -->
        <button id="btn-toggle-chaveamento" class="btn-toggle-chaveamento"
                {% if formato_campeonato == 'pontos_corridos' %}style="display: none;"{% endif %}>
            <span class="chaveamento-icon">üèÜ</span>
            <span class="chaveamento-text">Ver Chaveamento</span>
        </button>
    </div>

    {% if formato_campeonato and formato_campeonato != 'pontos_corridos' %}
        <div class="aviso-formato alert alert-info">
            <p>
                ‚ÑπÔ∏è <strong>Formato Hist√≥rico:</strong>
                {% if formato_campeonato == 'grupos_fases' %}
                    Este campeonato foi disputado em grupos e fases classificat√≥rias.
                    {% if fases_disponiveis %}
                        Use o seletor acima para escolher entre as diferentes fases.
                    {% endif %}
                {% elif formato_campeonato == 'mata_mata' %}
                    Este campeonato foi disputado em formato mata-mata e fases classificat√≥rias.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>

<!-- Container do Chaveamento -->
<div id="chaveamento-container" class="chaveamento-container" style="display: none;">
    <div class="chaveamento-header">
        <h2 class="chaveamento-title">Chaveamento do Mata-Mata</h2>
    </div>
    <div id="chaveamento-content" class="chaveamento-wrapper"></div>
    <div class="chaveamento-legenda">
        <div class="legenda-item">
            <div class="legenda-cor vencedor"></div>
            <span>Vencedor</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor perdedor"></div>
            <span>Eliminado</span>
        </div>
        <div class="legenda-item">
            <div class="legenda-cor penaltis"></div>
            <span>Decidido nos P√™naltis</span>
        </div>
    </div>
</div>

<!-- √Årea de Classifica√ß√£o e Jogos -->
<div class="container-tabelas-search">
    <!-- Classifica√ß√£o -->
    <div class="table-section">
        <h2 id="classificacao-titulo">
            Classifica√ß√£o
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} Final de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} at√© a Rodada {{ rodada_selecionada }} de {{ ano_selecionado }}
                    {% endif %}
                {% else %}
                    {% if fase_selecionada %} - {{ fase_selecionada }} de {{ ano_selecionado }}
                    {% else %} de {{ ano_selecionado }}
                    {% endif %}
                {% endif %}
            {% endif %}
        </h2>

        <!-- Se houver grupos, mostrar classifica√ß√£o por grupo -->
        {% if classificacoes_por_grupo %}
            {% for grupo, classificacao in classificacoes_por_grupo.items() %}
                <div class="grupo-classificacao">
                    <h3 class="grupo-titulo">{{ grupo }}</h3>
                    <table class="tabela-classificacao">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Clube</th>
                                <th>J</th>
                                <th>Pts</th>
                                <th>V</th>
                                <th>E</th>
                                <th>D</th>
                                <th>GM</th>
                                <th>GC</th>
                                <th>SG</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ranking in classificacao %}
                            <tr>
                                <td>{{ ranking["posicao"] }}</td>
                                <td><a href="{{ url_for('clube', nome=ranking['clube']) }}">{{ ranking["clube"] }}</a></td>
                                <td>{{ ranking["total_jogos"] }}</td>
                                <td><strong>{{ ranking["pontos"] }}</strong></td>
                                <td>{{ ranking["vitorias"] }}</td>
                                <td>{{ ranking["empates"] }}</td>
                                <td>{{ ranking["derrotas"] }}</td>
                                <td>{{ ranking["gm"] }}</td>
                                <td>{{ ranking["gs"] }}</td>
                                <td>{{ ranking["sg"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% elif classificacoes %}
            <!-- Classifica√ß√£o √∫nica (sem grupos) -->
            <table class="tabela-classificacao" id="tabela-classificacao-anual">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Clube</th>
                        <th>J</th>
                        <th>Pts</th>
                        <th>V</th>
                        <th>E</th>
                        <th>D</th>
                        <th>GM</th>
                        <th>GC</th>
                        <th>SG</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ranking in classificacoes %}
                    <tr>
                        <td>{{ ranking["posicao"] }}</td>
                        <td><a href="{{ url_for('clube', nome=ranking['clube']) }}">{{ ranking["clube"] }}</a></td>
                        <td>{{ ranking["total_jogos"] }}</td>
                        <td><strong>{{ ranking["pontos"] }}</strong></td>
                        <td>{{ ranking["vitorias"] }}</td>
                        <td>{{ ranking["empates"] }}</td>
                        <td>{{ ranking["derrotas"] }}</td>
                        <td>{{ ranking["gm"] }}</td>
                        <td>{{ ranking["gs"] }}</td>
                        <td>{{ ranking["sg"] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Selecione um ano acima para ver a classifica√ß√£o.</div>
        {% endif %}
    </div>

    <!-- Jogos -->
    <div class="table-section">
        <h2 id="jogos-titulo">
            Jogos
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} da Rodada {{ rodada_selecionada }} de {{ ano_selecionado }}
                    {% endif %}
                {% else %}
                    {% if fase_selecionada %} - {{ fase_selecionada }} de {{ ano_selecionado }}
                    {% else %} de {{ ano_selecionado }}
                    {% endif %}
                {% endif %}
            {% endif %}
        </h2>

        {% if jogos %}
            <table class="tabela-jogos">
                <thead>
                    <tr>
                        <th>Data</th>
                        {% if formato_campeonato != 'pontos_corridos' %}
                            <th>Grupo</th>
                        {% endif %}
                        <th>Rodada</th>
                        <th>Mandante</th>
                        <th>Placar</th>
                        <th>Visitante</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jogo in jogos %}
                    <tr>
                        <td>{{ jogo["data"] }}</td>
                        {% if formato_campeonato != 'pontos_corridos' %}
                            <td>{{ jogo["grupo"] or "-" }}</td>
                        {% endif %}
                        <td>{{ jogo["rodada"] or jogo["fase"] }}</td>
                        <td><a href="{{ url_for('clube', nome=jogo['mandante']) }}">{{ jogo["mandante"] }}</a></td>
                        <td class="placar-cell">
                            <a href="{{ url_for('jogo', jogo_id=jogo['ID']) }}">
                                <strong>{{ jogo["mandante_placar"] }} x {{ jogo["visitante_placar"] }}</strong>
                            </a>
                        </td>
                        <td><a href="{{ url_for('clube', nome=jogo['visitante']) }}">{{ jogo["visitante"] }}</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Selecione um ano acima para ver os jogos.</div>
        {% endif %}
    </div>
</div>

<style>
.controls-container {
    background: var(--bg-primary);
    padding: var(--spacing-2xl);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--spacing-3xl);
}

.controls-container h3 {
    margin: 0 0 var(--spacing-xl) 0;
    color: var(--text-primary);
    font-size: var(--font-size-2xl);
}

.selects-container {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
    align-items: center;
}

.selects-container select {
    flex: 1;
    min-width: 200px;
}

.container-tabelas-search {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-3xl);
}

.table-section {
    background: var(--bg-primary);
    padding: var(--spacing-2xl);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
}

.table-section h2 {
    margin: 0 0 var(--spacing-xl) 0;
    color: var(--text-primary);
    padding-bottom: var(--spacing-md);
    border-bottom: 3px solid var(--primary-color);
    font-size: var(--font-size-xl);
}

/* Grupos */
.grupo-classificacao {
    margin-bottom: 30px;
}

.grupo-classificacao:last-child {
    margin-bottom: 0;
}

.grupo-titulo {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 8px 8px 0 0;
    margin: 0 0 0 0;
    font-size: 1.1em;
    font-weight: 700;
}

.grupo-classificacao .tabela-classificacao {
    border-radius: 0 0 8px 8px;
    margin-top: 0;
}

.placar-cell {
    text-align: center;
    font-size: 1.1em;
}

.placar-cell a {
    color: var(--text-primary);
    text-decoration: none;
    transition: color 0.2s;
}

.placar-cell a:hover {
    color: var(--primary-color);
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    background: var(--gray-100);
    border-radius: var(--radius-lg);
    color: var(--text-muted);
}

.aviso-formato {
    margin-top: 20px;
    background: #d6eaf8;
    border-left: 4px solid #3498db;
    padding: 15px 20px;
    border-radius: 8px;
}

.aviso-formato p {
    margin: 0;
    color: #2c3e50;
    line-height: 1.6;
}

@media (max-width: 992px) {
    .container-tabelas-search {
        grid-template-columns: 1fr;
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
window.ALL_CLUBS = {{ clubes_json | safe }};

document.addEventListener('DOMContentLoaded', () => {
    const selectAnoSearch = document.querySelector('#select-ano-search');
    const selectFaseSearch = document.querySelector('#select-fase-search');
    const selectRodadaSearch = document.querySelector('#select-rodada-search');
    const btnToggleChaveamento = document.querySelector('#btn-toggle-chaveamento');

    let currentYear = {{ ano_selecionado | tojson }};
    let currentFase = {{ fase_selecionada | tojson }};
    let currentRodada = {{ rodada_selecionada | tojson }};
    let currentFormato = {{ formato_campeonato | tojson }};

    // Event Listeners
    selectAnoSearch.addEventListener('change', async () => {
        currentYear = selectAnoSearch.value;
        if (currentYear) {
            await loadYearData(currentYear);
        } else {
            resetUI();
        }
    });

    selectFaseSearch.addEventListener('change', async () => {
        currentFase = selectFaseSearch.value;
        if (currentYear && currentFase) {
            history.pushState(null, '', `/search?data=${currentYear}&fase=${currentFase}`);
            location.reload();
        }
    });

    async function loadYearData(year) {
        try {
            // Buscar formato do campeonato
            const formatoResp = await fetch(`/api/formato_campeonato/${year}`);
            const formatoData = await formatoResp.json();
            currentFormato = formatoData.formato;

            if (currentFormato === 'pontos_corridos') {
                selectFaseSearch.style.display = 'none';
                selectRodadaSearch.style.display = 'inline-block';
                if (btnToggleChaveamento) btnToggleChaveamento.style.display = 'none';

                // Carregar rodadas
                await populateRodadaDropdown(year);
            } else {
                // Campeonatos com fases/grupos
                selectRodadaSearch.style.display = 'none';
                if (btnToggleChaveamento) btnToggleChaveamento.style.display = 'flex';

                // Buscar fases dispon√≠veis
                const fasesResp = await fetch(`/api/fases/${year}`);
                const fases = await fasesResp.json();

                if (fases && fases.length > 0) {
                    selectFaseSearch.style.display = 'inline-block';
                    selectFaseSearch.innerHTML = '<option value="">Selecione a Fase</option>';

                    fases.forEach(fase => {
                        const option = document.createElement('option');
                        option.value = fase;
                        option.textContent = fase;
                        selectFaseSearch.appendChild(option);
                    });

                    // Selecionar primeira fase por padr√£o
                    const primeiraFase = fases[0];
                    selectFaseSearch.value = primeiraFase;
                    history.pushState(null, '', `/search?data=${year}&fase=${primeiraFase}`);
                    location.reload();
                } else {
                    history.pushState(null, '', `/search?data=${year}`);
                    location.reload();
                }
            }
        } catch (error) {
            console.error('Erro ao carregar dados do ano:', error);
        }
    }

    async function populateRodadaDropdown(year) {
        try {
            const response = await fetch(`/api/max_rodada/${year}`);
            const maxRodada = await response.json();

            selectRodadaSearch.innerHTML = '<option value="">Selecione a Rodada</option>';
            selectRodadaSearch.innerHTML += '<option value="0">Classifica√ß√£o Final / Todos os Jogos</option>';

            if (maxRodada > 0) {
                for (let i = 1; i <= maxRodada; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Rodada ${i}`;
                    selectRodadaSearch.appendChild(option);
                }
                selectRodadaSearch.value = maxRodada;
            }

            history.pushState(null, '', `/search?data=${year}&rodada=${maxRodada || 0}`);
            location.reload();
        } catch (error) {
            console.error('Erro ao carregar rodadas:', error);
        }
    }

    function resetUI() {
        selectFaseSearch.style.display = 'none';
        selectRodadaSearch.style.display = 'none';
        if (btnToggleChaveamento) btnToggleChaveamento.style.display = 'none';
        history.pushState(null, '', '/search');
        location.reload();
    }
});
</script>
{% endblock %}
