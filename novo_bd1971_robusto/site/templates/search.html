{% extends "layout.html" %}

{% block body %}
<div class="controls-container">
    <h3>
        Campeonato Brasileiro
        {% if q %}Clube: {{ q }}{% endif %}
        {% if ano_selecionado %} de {{ ano_selecionado }} {% endif %}
    </h3>

    <div class="selects-container">
        <select id="select-ano-search">
            <option value="">Selecione outro Ano</option>
            {% for year in datas %}
                <option value="{{ year }}" {% if year == ano_selecionado %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <select id="select-rodada-search" {% if not ano_selecionado %}style="display: none;"{% endif %}>
            <option value="">Selecione a Rodada</option>
        </select>
    </div>
</div>

<div class="container-tabelas-search">
    <div class="table-section">
        <h2 id="classificacao-titulo">Classificação
            {% if ano_selecionado %}
                {% if rodada_selecionada == 0 %} Final de {{ ano_selecionado }}
                {% elif rodada_selecionada %} de {{ ano_selecionado }} até a Rodada {{ rodada_selecionada }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-classificacao" id="tabela-classificacao-anual">
            <thead>
                <tr>
                    <th>Posição</th>
                    <th>Clube</th>
                    <th>Jogos</th>
                    <th>Pontos</th>
                    <th>Vitórias</th>
                    <th>Empates</th>
                    <th>Derrotas</th>
                    <th>GM</th>
                    <th>GC</th>
                    <th>SG</th>
                </tr>
            </thead>
            <tbody id="tabela-classificacao-anual-tbody">
                <!-- conteúdo preenchido no backend ou via JS -->
            </tbody>
        </table>
    </div>

    <div class="table-section">
        <h2 id="jogos-titulo">Jogos
            {% if ano_selecionado %}
                {% if rodada_selecionada == 0 %} de {{ ano_selecionado }}
                {% elif rodada_selecionada %} da Rodada {{ rodada_selecionada }} de {{ ano_selecionado }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-jogos" id="tabela-jogos-anual">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Rodada</th>
                    <th>Mandante</th>
                    <th>Placar</th>
                    <th>Visitante</th>
                </tr>
            </thead>
            <tbody id="tabela-jogos-anual-tbody">
                <!-- conteúdo preenchido no backend ou via JS -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Define ALL_CLUBS globalmente para o autocomplete do navbar
    window.ALL_CLUBS = {{ clubes_json | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        const selectAnoSearch = document.querySelector('#select-ano-search');
        const selectRodadaSearch = document.querySelector('#select-rodada-search');
        const tabelaClassificacaoTbody = document.querySelector('#tabela-classificacao-anual-tbody');
        const tabelaJogosTbody = document.querySelector('#tabela-jogos-anual-tbody');
        const anoSelecionadoHeader = document.querySelector('#classificacao-titulo');
        const jogosAnoHeader = document.querySelector('#jogos-titulo');

        let currentYear = {{ ano_selecionado | tojson }};
        let currentRodada = {{ rodada_selecionada | tojson }};

        console.log("DOM Loaded. Initial currentYear:", currentYear, "currentRodada:", currentRodada);

        // Funções definidas no topo do escopo DOMContentLoaded
        async function populateRodadaDropdown(year, selectedRodada = null) {
            console.log(`populateRodadaDropdown called for year: ${year}, selectedRodada: ${selectedRodada}`);

            selectRodadaSearch.innerHTML = '<option value="">Selecione a Rodada</option>';
            selectRodadaSearch.innerHTML += '<option value="0">Classificação Final / Todos os Jogos</option>';

            if (!year) {
                selectRodadaSearch.style.display = 'none';
                console.log("No year selected. Hiding round dropdown.");
                return 0;
            }

            let maxRodadaFromAPI = 0;

            try {
                const response = await fetch(`/api/max_rodada/${year}`);
                console.log(`Fetch /api/max_rodada/${year} response status: ${response.status}`);

                if (!response.ok) {
                    throw new Error('Erro ao carregar rodadas. Status: ' + response.status);
                }
                maxRodadaFromAPI = await response.json();
                console.log(`Max rodada received from API: ${maxRodadaFromAPI}`);

                if (typeof maxRodadaFromAPI === 'number' && maxRodadaFromAPI > 0) {
                    for (let i = 1; i <= maxRodadaFromAPI; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Rodada ${i}`;
                        selectRodadaSearch.appendChild(option);
                    }
                    selectRodadaSearch.style.display = 'inline-block';
                    console.log(`Successfully populated ${maxRodadaFromAPI} rounds.`);
                } else {
                    console.log(`maxRodadaFromAPI is not a positive number (${maxRodadaFromAPI}). No specific rounds added.`);
                    selectRodadaSearch.style.display = 'inline-block';
                }

                let defaultSelection = null;
                if (selectedRodada !== null && (selectedRodada === 0 || (maxRodadaFromAPI > 0 && selectedRodada <= maxRodadaFromAPI))) {
                    defaultSelection = selectedRodada;
                    console.log(`Defaulting to selectedRodada from URL/param: ${defaultSelection}`);
                } else if (maxRodadaFromAPI > 0) {
                    defaultSelection = maxRodadaFromAPI;
                    console.log(`Defaulting to last round: ${defaultSelection}`);
                } else {
                    defaultSelection = "0";
                    console.log(`Defaulting to 0 (final classification) as no rounds found: ${defaultSelection}`);
                }

                if (defaultSelection !== null && selectRodadaSearch.querySelector(`option[value="${defaultSelection}"]`)) {
                    selectRodadaSearch.value = defaultSelection;
                    console.log(`Dropdown value set to: ${selectRodadaSearch.value}`);
                } else {
                    selectRodadaSearch.value = "0";
                    console.log(`Could not set dropdown value to ${defaultSelection}. Falling back to 0.`);
                }

            } catch (error) {
                console.error('Error in populateRodadaDropdown:', error);
                selectRodadaSearch.innerHTML = '<option value="">Erro ao carregar rodadas</option>';
                selectRodadaSearch.style.display = 'inline-block';
            }
            return maxRodadaFromAPI;
        }

        async function updateTables(year, rodada) {
            console.log(`updateTables called for year: ${year}, rodada: ${rodada}`);
            tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Carregando classificação...</td></tr>`;
            tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Carregando jogos...</td></tr>`;

            if (anoSelecionadoHeader) {
                if (rodada === 0) {
                    anoSelecionadoHeader.textContent = `Classificação Final de ${year}`;
                } else {
                    anoSelecionadoHeader.textContent = `Classificação de ${year} até a Rodada ${rodada}`;
                }
            }
            if (jogosAnoHeader) {
                if (rodada === 0) {
                    jogosAnoHeader.textContent = `Todos os Jogos de ${year}`;
                } else {
                    jogosAnoHeader.textContent = `Jogos da Rodada ${rodada} de ${year}`;
                }
            }

            try {
                const classificacaoResponse = await fetch(`/api/classificacao/${year}/${rodada}`);
                if (!classificacaoResponse.ok) throw new Error('Erro ao carregar classificação.');
                const classificacoes = await classificacaoResponse.json();

                tabelaClassificacaoTbody.innerHTML = '';
                if (classificacoes.length > 0) {
                    classificacoes.forEach(ranking => {
                        const row = `
                            <tr>
                                <td>${ranking.posicao}</td>
                                <td><a href="/clube/${ranking.clube}">${ranking.clube}</a></td>
                                <td>${ranking.total_jogos}</td>
                                <td><strong>${ranking.pontos}</strong></td>
                                <td>${ranking.vitorias}</td>
                                <td>${ranking.empates}</td>
                                <td>${ranking.derrotas}</td>
                                <td>${ranking.gm}</td>
                                <td>${ranking.gs}</td>
                                <td>${ranking.sg}</td>
                            </tr>
                        `;
                        tabelaClassificacaoTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Nenhuma classificação encontrada.</td></tr>`;
                }

                const jogosResponse = await fetch(`/api/jogos/${year}/${rodada}`);
                if (!jogosResponse.ok) throw new Error('Erro ao carregar jogos.');
                const jogos = await jogosResponse.json();

                console.log("Jogos recebidos da API:", jogos);

                tabelaJogosTbody.innerHTML = '';
                if (jogos.length > 0) {
                    jogos.forEach(jogo => {
                        const row = `
                            <tr>
                                <td>${jogo.data}</td>
                                <td>${jogo.rodada}</td>
                                <td><a href="/clube/${jogo.mandante}">${jogo.mandante}</a></td>
                                <td><a href="/estatisticas/${jogo.ID}">${jogo.mandante_placar} x ${jogo.visitante_placar}</a></td>
                                <td><a href="/clube/${jogo.visitante}">${jogo.visitante}</a></td>
                            </tr>
                        `;
                        tabelaJogosTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum jogo encontrado.</td></tr>`;
                }

            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Erro ao carregar dados da classificação.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados dos jogos.</td></tr>`;
            }
        }

        // Listener para mudança no dropdown de Ano
        selectAnoSearch.addEventListener('change', async () => {
            currentYear = selectAnoSearch.value;
            currentRodada = null;

            if (currentYear) {
                const maxRodadaDoAno = await populateRodadaDropdown(currentYear, currentRodada);
                if (maxRodadaDoAno > 0) {
                    history.pushState(null, '', `/search?data=${currentYear}&rodada=${maxRodadaDoAno}`);
                    await updateTables(currentYear, maxRodadaDoAno);
                } else {
                    history.pushState(null, '', `/search?data=${currentYear}`);
                    await updateTables(currentYear, 0);
                }
            } else {
                selectRodadaSearch.style.display = 'none';
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Selecione um ano acima para ver a classificação e jogos.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Selecione um ano acima para ver a classificação e jogos.</td></tr>`;
                if (anoSelecionadoHeader) {
                    anoSelecionadoHeader.textContent = `Classificação`;
                }
                if (jogosAnoHeader) {
                    jogosAnoHeader.textContent = `Jogos`;
                }
                history.pushState(null, '', `/search`);
            }
        });

        // Listener para mudança no dropdown de Rodada
        selectRodadaSearch.addEventListener('change', async () => {
            currentRodada = selectRodadaSearch.value ? parseInt(selectRodadaSearch.value) : null;
            if (currentYear && currentRodada !== null) {
                await updateTables(currentYear, currentRodada);
                if (currentRodada === 0) {
                    history.pushState(null, '', `/search?data=${currentYear}`);
                } else {
                    history.pushState(null, '', `/search?data=${currentYear}&rodada=${currentRodada}`);
                }
            } else if (currentYear) {
                 const maxRodadaDoAnoParaReset = await populateRodadaDropdown(currentYear, null);
                 if (maxRodadaDoAnoParaReset > 0) {
                    history.pushState(null, '', `/search?data=${currentYear}&rodada=${maxRodadaDoAnoParaReset}`);
                    await updateTables(currentYear, maxRodadaDoAnoParaReset);
                 } else {
                    history.pushState(null, '', `/search?data=${currentYear}`);
                    await updateTables(currentYear, 0);
                 }
            }
        });

        // Chamada inicial ao carregar a página
        if (currentYear) {
            populateRodadaDropdown(currentYear, currentRodada).then((maxRodadaFetched) => {
                let initialRodadaToUse;
                if (currentRodada !== null && (currentRodada === 0 || (maxRodadaFetched > 0 && currentRodada <= maxRodadaFetched))) {
                    initialRodadaToUse = currentRodada;
                } else if (maxRodadaFetched > 0) {
                    initialRodadaToUse = maxRodadaFetched;
                } else {
                    initialRodadaToUse = 0;
                }
                console.log(`Initial updateTables call with year: ${currentYear}, rodada: ${initialRodadaToUse}`);
                updateTables(currentYear, initialRodadaToUse);
            });
        } else {
            selectRodadaSearch.style.display = 'none';
            tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Selecione um ano acima para ver a classificação e jogos.</td></tr>`;
            tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Selecione um ano acima para ver a classificação e jogos.</td></tr>`;
            if (anoSelecionadoHeader) {
                anoSelecionadoHeader.textContent = `Classificação`;
            }
            if (jogosAnoHeader) {
                jogosAnoHeader.textContent = `Jogos`;
            }
        }
    });
</script>
{% endblock %}
