
{% extends "layout.html" %}

{% block body %}
<div class="controls-container">
    <h3>
        Campeonato Brasileiro
        {% if q %}Clube: {{ q }}{% endif %}
        {% if ano_selecionado %} de {{ ano_selecionado }} {% endif %}
    </h3>

    <div class="selects-container">
        <select id="select-ano-search">
            <option value="">Selecione outro Ano</option>
            {% for year in datas %}
                <option value="{{ year }}" {% if year == ano_selecionado %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown de rodada só aparece para pontos corridos (2003+) -->
        <select id="select-rodada-search" {% if not ano_selecionado or formato_campeonato != 'pontos_corridos' %}style="display: none;"{% endif %}>
            <option value="">Selecione a Rodada</option>
        </select>
    </div>

    {% if formato_campeonato and formato_campeonato != 'pontos_corridos' %}
        <div class="aviso-formato">
            <p>
                ℹ️ <strong>Formato Histórico:</strong>
                {% if formato_campeonato == 'grupos_fases' %}
                    Este campeonato foi disputado em grupos e fases eliminatórias.
                {% elif formato_campeonato == 'mata_mata' %}
                    Este campeonato foi disputado em formato mata-mata e fases classificatórias.
                {% endif %}
                A classificação mostrada é a final do campeonato.
            </p>
        </div>
    {% endif %}
</div>

<div class="container-tabelas-search">
    <div class="table-section">
        <h2 id="classificacao-titulo">Classificação
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} Final de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} de {{ ano_selecionado }} até a Rodada {{ rodada_selecionada }}
                    {% endif %}
                {% else %}
                    Final de {{ ano_selecionado }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-classificacao" id="tabela-classificacao-anual">
            <thead>
                <tr>
                    <th>Posição</th>
                    <th>Clube</th>
                    <th>Jogos</th>
                    <th>Pontos</th>
                    <th>Vitórias</th>
                    <th>Empates</th>
                    <th>Derrotas</th>
                    <th>GM</th>
                    <th>GC</th>
                    <th>SG</th>
                </tr>
            </thead>
            <tbody id="tabela-classificacao-anual-tbody">
                {% if classificacoes %}
                    {% for ranking in classificacoes %}
                    <tr>
                        <td>{{ ranking["posicao"] }}</td>
                        <td><a href="{{ url_for('clube', nome=ranking['clube']) }}">{{ ranking["clube"] }}</a></td>
                        <td>{{ ranking["total_jogos"] }}</td>
                        <td><strong>{{ ranking["pontos"] }}</strong></td>
                        <td>{{ ranking["vitorias"] }}</td>
                        <td>{{ ranking["empates"] }}</td>
                        <td>{{ ranking["derrotas"] }}</td>
                        <td>{{ ranking["gm"] }}</td>
                        <td>{{ ranking["gs"] }}</td>
                        <td>{{ ranking["sg"] }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="10" style="text-align: center;">Selecione um ano acima para ver a classificação.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="table-section">
        <h2 id="jogos-titulo">Jogos
            {% if ano_selecionado %}
                {% if formato_campeonato == 'pontos_corridos' %}
                    {% if rodada_selecionada == 0 %} de {{ ano_selecionado }}
                    {% elif rodada_selecionada %} da Rodada {{ rodada_selecionada }} de {{ ano_selecionado }}
                    {% endif %}
                {% else %}
                    de {{ ano_selecionado }}
                {% endif %}
            {% endif %}
        </h2>
        <table class="tabela-jogos" id="tabela-jogos-anual">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Rodada/Fase</th>
                    <th>Mandante</th>
                    <th>Placar</th>
                    <th>Visitante</th>
                </tr>
            </thead>
            <tbody id="tabela-jogos-anual-tbody">
                {% if jogos %}
                    {% for jogo in jogos %}
                    <tr>
                        <td>{{ jogo["data"] }}</td>
                        <td>{{ jogo["rodada"] }}</td>
                        <td><a href="{{ url_for('clube', nome=jogo['mandante']) }}">{{ jogo["mandante"] }}</a></td>
                        <td><a href="{{ url_for('jogo', jogo_id=jogo['ID']) }}">{{ jogo["mandante_placar"] }} x {{ jogo["visitante_placar"] }}</a></td>
                        <td><a href="{{ url_for('clube', nome=jogo['visitante']) }}">{{ jogo["visitante"] }}</a></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5" style="text-align: center;">Selecione um ano acima para ver os jogos.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>
    window.ALL_CLUBS = {{ clubes_json | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        const selectAnoSearch = document.querySelector('#select-ano-search');
        const selectRodadaSearch = document.querySelector('#select-rodada-search');
        const tabelaClassificacaoTbody = document.querySelector('#tabela-classificacao-anual-tbody');
        const tabelaJogosTbody = document.querySelector('#tabela-jogos-anual-tbody');
        const anoSelecionadoHeader = document.querySelector('#classificacao-titulo');
        const jogosAnoHeader = document.querySelector('#jogos-titulo');

        let currentYear = {{ ano_selecionado | tojson }};
        let currentRodada = {{ rodada_selecionada | tojson }};
        let currentFormato = {{ formato_campeonato | tojson }};

        async function checkFormatoAndPopulateRodada(year) {
            try {
                const formatoResp = await fetch(`/api/formato_campeonato/${year}`);
                const formatoData = await formatoResp.json();
                currentFormato = formatoData.formato;

                if (currentFormato === 'pontos_corridos') {
                    await populateRodadaDropdown(year);
                    selectRodadaSearch.style.display = 'inline-block';
                } else {
                    selectRodadaSearch.style.display = 'none';
                }

                return currentFormato;
            } catch (error) {
                console.error('Erro ao verificar formato:', error);
                return 'pontos_corridos';
            }
        }

        async function populateRodadaDropdown(year, selectedRodada = null) {
            selectRodadaSearch.innerHTML = '<option value="">Selecione a Rodada</option>';
            selectRodadaSearch.innerHTML += '<option value="0">Classificação Final / Todos os Jogos</option>';

            if (!year) {
                selectRodadaSearch.style.display = 'none';
                return 0;
            }

            let maxRodadaFromAPI = 0;

            try {
                const response = await fetch(`/api/max_rodada/${year}`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar rodadas.');
                }
                maxRodadaFromAPI = await response.json();

                if (typeof maxRodadaFromAPI === 'number' && maxRodadaFromAPI > 0) {
                    for (let i = 1; i <= maxRodadaFromAPI; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Rodada ${i}`;
                        selectRodadaSearch.appendChild(option);
                    }
                    selectRodadaSearch.style.display = 'inline-block';
                }

                let defaultSelection = null;
                if (selectedRodada !== null && (selectedRodada === 0 || (maxRodadaFromAPI > 0 && selectedRodada <= maxRodadaFromAPI))) {
                    defaultSelection = selectedRodada;
                } else if (maxRodadaFromAPI > 0) {
                    defaultSelection = maxRodadaFromAPI;
                } else {
                    defaultSelection = "0";
                }

                if (defaultSelection !== null && selectRodadaSearch.querySelector(`option[value="${defaultSelection}"]`)) {
                    selectRodadaSearch.value = defaultSelection;
                }

            } catch (error) {
                console.error('Erro:', error);
                selectRodadaSearch.innerHTML = '<option value="">Erro ao carregar rodadas</option>';
                selectRodadaSearch.style.display = 'inline-block';
            }
            return maxRodadaFromAPI;
        }

        async function updateTables(year, rodada) {
            tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Carregando...</td></tr>`;
            tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>`;

            if (anoSelecionadoHeader) {
                if (currentFormato === 'pontos_corridos') {
                    if (rodada === 0) {
                        anoSelecionadoHeader.textContent = `Classificação Final de ${year}`;
                    } else {
                        anoSelecionadoHeader.textContent = `Classificação de ${year} até a Rodada ${rodada}`;
                    }
                } else {
                    anoSelecionadoHeader.textContent = `Classificação Final de ${year}`;
                }
            }

            if (jogosAnoHeader) {
                if (currentFormato === 'pontos_corridos') {
                    if (rodada === 0) {
                        jogosAnoHeader.textContent = `Todos os Jogos de ${year}`;
                    } else {
                        jogosAnoHeader.textContent = `Jogos da Rodada ${rodada} de ${year}`;
                    }
                } else {
                    jogosAnoHeader.textContent = `Jogos de ${year}`;
                }
            }

            try {
                const classificacaoResponse = await fetch(`/api/classificacao/${year}/${rodada}`);
                if (!classificacaoResponse.ok) throw new Error('Erro ao carregar classificação.');
                const classificacoes = await classificacaoResponse.json();

                tabelaClassificacaoTbody.innerHTML = '';
                if (classificacoes.length > 0) {
                    classificacoes.forEach(ranking => {
                        const row = `
                            <tr>
                                <td>${ranking.posicao}</td>
                                <td><a href="/clube/${ranking.clube}">${ranking.clube}</a></td>
                                <td>${ranking.total_jogos}</td>
                                <td><strong>${ranking.pontos}</strong></td>
                                <td>${ranking.vitorias}</td>
                                <td>${ranking.empates}</td>
                                <td>${ranking.derrotas}</td>
                                <td>${ranking.gm}</td>
                                <td>${ranking.gs}</td>
                                <td>${ranking.sg}</td>
                            </tr>
                        `;
                        tabelaClassificacaoTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Nenhuma classificação encontrada.</td></tr>`;
                }

                const jogosResponse = await fetch(`/api/jogos/${year}/${rodada}`);
                if (!jogosResponse.ok) throw new Error('Erro ao carregar jogos.');
                const jogos = await jogosResponse.json();

                tabelaJogosTbody.innerHTML = '';
                if (jogos.length > 0) {
                    jogos.forEach(jogo => {
                        const row = `
                            <tr>
                                <td>${jogo.data}</td>
                                <td>${jogo.rodada}</td>
                                <td><a href="/clube/${jogo.mandante}">${jogo.mandante}</a></td>
                                <td><a href="/jogo/${jogo.ID}">${jogo.mandante_placar} x ${jogo.visitante_placar}</a></td>
                                <td><a href="/clube/${jogo.visitante}">${jogo.visitante}</a></td>
                            </tr>
                        `;
                        tabelaJogosTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum jogo encontrado.</td></tr>`;
                }

            } catch (error) {
                console.error('Erro:', error);
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Erro ao carregar dados.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados.</td></tr>`;
            }
        }

        selectAnoSearch.addEventListener('change', async () => {
            currentYear = selectAnoSearch.value;
            currentRodada = null;

            if (currentYear) {
                const formato = await checkFormatoAndPopulateRodada(currentYear);

                if (formato === 'pontos_corridos') {
                    const maxRodadaDoAno = await populateRodadaDropdown(currentYear, currentRodada);
                    const rodadaParaUsar = maxRodadaDoAno > 0 ? maxRodadaDoAno : 0;
                    history.pushState(null, '', `/search?data=${currentYear}&rodada=${rodadaParaUsar}`);
                    await updateTables(currentYear, rodadaParaUsar);
                } else {
                    history.pushState(null, '', `/search?data=${currentYear}`);
                    await updateTables(currentYear, 0);
                }
            } else {
                selectRodadaSearch.style.display = 'none';
                tabelaClassificacaoTbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">Selecione um ano.</td></tr>`;
                tabelaJogosTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Selecione um ano.</td></tr>`;
                history.pushState(null, '', `/search`);
            }
        });

        selectRodadaSearch.addEventListener('change', async () => {
            currentRodada = selectRodadaSearch.value ? parseInt(selectRodadaSearch.value) : null;
            if (currentYear && currentRodada !== null) {
                await updateTables(currentYear, currentRodada);
                history.pushState(null, '', `/search?data=${currentYear}&rodada=${currentRodada}`);
            }
        });

        // Inicialização
        if (currentYear) {
            checkFormatoAndPopulateRodada(currentYear).then(() => {
                if (currentFormato === 'pontos_corridos') {
                    populateRodadaDropdown(currentYear, currentRodada);
                }
            });
        }
    });
</script>

{% endblock %}
